package hydra.sql

import com.pluralsight.hydra.avro.JsonConverter
import com.typesafe.config.ConfigFactory
import hydra.avro.io
import hydra.avro.io.SaveMode
import hydra.avro.util.SchemaWrapper
import org.apache.avro.Schema
import org.apache.avro.generic.GenericRecord


/**
  * Created by alexsilva on 5/4/17.
  */
object WriterApp extends App {
  val schema =
    """
      |{"type":"record","name":"PathUpdated","namespace":"exp.paths.v2","fields":[{"name":"id","type":"string","doc":"GUID Identifier"},{"name":"assessment","type":["null",{"type":"record","name":"assessment_record","fields":[{"name":"id","type":"string","doc":"The text based id for the assessment"}]}],"default":null},{"name":"contentPillar","type":"string","doc":"The content pillar that the path is a part of."},{"name":"description","type":"string","doc":"A markdown based description for the path. A subset of markdown is supported this field."},{"name":"highlights","type":"string","doc":"A markdown based text for the highlights for the path. A subset of markdown is supported this field."},{"name":"numberOfCourses","type":"int","doc":"The number of courses that are part of the path."},{"name":"numberOfHours","type":"int","doc":"The number of hours of content that are part of the path.","default":null},{"name":"prerequisites","type":"string","doc":"A markdown based text of prerequisites for the path. A subset of markdown is supported this field."},{"name":"retired","type":"boolean","doc":"Whether or not the path has been retired or not. One note is that a Path can be un-retired."},{"name":"replacedById","type":["null","string"],"doc":"Id of the path that replaces this path in the case it was retired. Though it is possible that a path could be retired and not replaced.","default":null},{"name":"status","type":"string","doc":"Currently one of two values (published, retired)"},{"name":"title","type":"string","doc":"Title for the Path"},{"name":"thumbnailUrl","type":"string","doc":"The URL path to the image that gets displayed in the Thumbnail."},{"name":"type","type":"string","doc":"The type of path for the path being updated."},{"name":"url","type":"string","doc":"The URL Path to the Path"},{"name":"urlSlug","type":"string","doc":"The URL Slug for the Path"},{"name":"version","type":"int","doc":"The version number for Path."},{"name":"createdAt","type":{"type":"string","logicalType":"iso-datetime"},"doc":"The ISO formatted date/time for when the path was originally created."},{"name":"updatedAt","type":{"type":"string","logicalType":"iso-datetime"},"doc":"The ISO formatted date/time for when the path was last updated."},{"name":"publishedAt","type":{"type":"string","logicalType":"iso-datetime"},"doc":"The date the path first went live."},{"name":"authors","type":{"type":"array","items":{"type":"record","name":"authors_Record","fields":[{"name":"id","type":"string","doc":"The Id field for the author"},{"name":"authorHandle","type":"string","doc":"Corresponds to the authorHandle from ps.content.author-updated"}]}}},{"name":"pathLevels","type":{"type":"array","items":{"type":"record","name":"pathLevels_Record","fields":[{"name":"id","type":"string","doc":"The guid Id for the Path Level"},{"name":"transcenderExamId","type":["null","string"],"doc":"A unique identifier for a transcenderExam. Further information for these exams can be found from ps.assessment.certification-exam-discovered.v1","default":null},{"name":"title","type":"string","doc":"The title for the Path Level such as Beginner, Intermediate, etc."},{"name":"description","type":"string","doc":"A description for the Path Level"},{"name":"courses","type":{"type":"array","items":{"type":"record","name":"courses_Record","fields":[{"name":"id","type":"string","doc":"The id for the course in the level"},{"name":"deprecatedCourseId","type":"string"}]}}},{"name":"comingSoonCourses","type":["null",{"type":"array","items":{"type":"record","name":"comingSoonCoursesRecord","fields":[{"name":"id","type":"string","doc":"Corresponds to the id from ps.content.course-updated"}]}}],"default":null}]}}},{"name":"relatedTopics","type":{"type":"array","items":{"type":"record","name":"relatedTopicsRecord","fields":[{"name":"title","type":"string","doc":"The title of the related topic"}]}},"doc":"An array of related topics"}]}
    """.stripMargin
  val provider = DriverManagerConnectionProvider(ConfigFactory.parseString(
    """
      |connection.url = "jdbc:postgresql://localhost:5432/postgres?user=postgres&password=password"
    """.stripMargin))
  val writer = new JdbcRecordWriter(JdbcWriterSettings(ConfigFactory.empty),
    provider, SchemaWrapper.from(new Schema.Parser().parse(schema)), mode = SaveMode.Append)

  val json = """{"id": "1c762732-94f6-4678-a328-1f996d127c3f", "assessment": null, "contentPillar": "it-ops", "description": "Having a hard time deciding which project management certification to take on? CompTIA's vendor-neutral Project+ content focuses on the fundamentals, making it easy for beginners and old pros to follow.", "highlights": "### What you will learn\n\n- How to set up and initiate a project\n- Project characteristics, life cycle, and organizational structures\n- How to plan a project\n- How to execute and deliver a project\n- How to manage and communicate those changes\n- How to formally close a project\n", "numberOfCourses": 2, "numberOfHours": 11, "prerequisites": "No prior experience is necessary. This path is mainly for people with little to no project management experience.", "retired": false, "replacedById": null, "status": "published", "title": "CompTIA Project+", "thumbnailUrl": "https://pluralsight.imgix.net/paths/path-icons/comptia-project-7fea631277.png", "type": "certificate", "url": "/paths/certificate/comptia-project-plus", "urlSlug": "comptia-project-plus", "version": 1, "createdAt": "2016-05-13T14:48:19.998Z", "updatedAt": "2016-10-19T18:34:20.998Z", "publishedAt": "2016-05-13T14:48:19.998Z", "authors": [{"id": "3d2726b4-59ba-497f-982c-834162987a98", "authorHandle": "bill-kulterman"}], "pathLevels": [{"id": "adf41442-6ec7-48ca-ad7f-2f8bfe57346d", "transcenderExamId": null, "title": "Path Courses", "description": "This selection of courses will help you learn the fundamentals of project management, which includes an introduction to PMBOK® Process Groups and Knowledge Areas. Together, these courses will help you prepare for the CompTIA Project+ exam.", "courses": [{"id": "89c85e85-a0cc-48ab-b146-1ce3e27b2222", "deprecatedCourseId": "comptia-project-plus-pt1"}, {"id": "6b8e90c2-9661-423a-b880-2734d4ef7248", "deprecatedCourseId": "comptia-project-plus-pt2"}], "comingSoonCourses": []}], "relatedTopics": [{"title": "Project Manager"}, {"title": "Business Professional"}, {"title": "PRINCE2®"}, {"title": "PMP®"}, {"title": "Project Management"}]}"""
  val record = new JsonConverter[GenericRecord](new Schema.Parser().parse(schema)).convert(json)

  writer.execute(io.Upsert(record)).get
  writer.flush()
}